<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AchillesCLI Architecture</title>
  <link rel="stylesheet" href="../style.css" />
</head>
<body>
  <div class="page">
    <div class="nav-header">
      <h1>AchillesCLI Architecture</h1>
      <small>
        <a href="../index.html">Home</a> ·
        <a href="../specs/matrix.html">Specs</a>
      </small>
    </div>

    <div class="section-intro">
      <p>
        AchillesCLI is a layered terminal tool: a thin CLI shell orchestrates LLM-backed skills, plans, and a managed `.specs`
        workspace. The flow mirrors GAMP: URS → FS/NFS → DS → Tests, with a DS per file as the technical source of truth.
      </p>
    </div>

    <h2>Runtime layers</h2>
    <ul>
      <li><strong>CLI Shell</strong> (`achilles-cli.mjs`): parses commands, manages history, prompts, cancellation, and interactive loop.</li>
      <li><strong>Planning & Execution</strong> (`planService`, `intentionToSkill`, `executionHelpers`): builds LLM plans, executes skills, resumes or cancels.</li>
      <li><strong>Skill Runtime</strong> (`RecursiveSkilledAgent` from achillesAgentLib): registers local skills, resolves orchestrators, runs with review mode.</li>
      <li><strong>Memory</strong> (`MemoryManager`): global/user/session memories, routed by LLM into `.history_*` snapshots.</li>
      <li><strong>Specs Workspace</strong> (`GampRSP`): creates `.specs`, manages URS/FS/NFS/DS files, traceability, HTML docs.</li>
      <li><strong>Bootstrap</strong> (`bootstrapHelpers`): auto-runs default steps (e.g., ignore-files) and caches completion.</li>
    </ul>

    <h2>Data directories</h2>
    <ul>
      <li><code>.specs/</code>: URS.md, FS.md, NFS.md, DS/*, .ignore, .llm_logs, .llm_stats, html_docs/.</li>
      <li><code>docs/specs/</code>: Published specification set (this documentation) with DS-per-file mirror.</li>
      <li><code>docs/architecture/</code>: HTML narratives of runtime layers and flows.</li>
    </ul>

    <h2>Key flows</h2>
    <ol>
      <li><strong>Bootstrap</strong>: detect `.specs`; if missing, create URS/FS/NFS skeletons, DS/, ignore list.</li>
      <li><strong>Task intake</strong>: user enters free text or commands; LLM planner emits skill steps; user may confirm.</li>
      <li><strong>Execution</strong>: skills run with context (workspace, specsRoot, memories, language contract); actions update specs.</li>
      <li><strong>Memory & Resume</strong>: summaries routed to global/user/session; pending plans persisted in-process for /resume.</li>
      <li><strong>Spec publishing</strong>: `GampRSP.generateHtmlDocs()` renders html_docs for browsing; docs/specs mirrored for static docs.</li>
    </ol>

    <h2>LLM & skills</h2>
    <p>
      AchillesCLI wraps <code>LLMAgent</code> (fast/deep modes, cancellation, debug logging) and executes local skills discovered under
      <code>.AchillesSkills</code> (workspace or CLI bundle). The planner prefers orchestrator skills for high-level tasks and warns when none exist.
    </p>
    <p><strong>Installed skills (type: oskill<sup>1</sup>)</strong></p>
    <ul>
      <li><code>update-specs</code> — plans and applies URS/FS/NFS/DS/test/file-impact actions from change requests.</li>
      <li><code>build-code</code> — regenerates files from DS File Impact blocks and scaffolds FS/NFS test suites.</li>
      <li><code>sync-specs</code> — scans code and drafts specs/DS/file-impact to sync undocumented files.</li>
      <li><code>ignore-files</code> — maintains the <code>.specs/.ignore</code> list of skipped paths.</li>
      <li><code>generate-docs</code> — rebuilds static HTML docs from the current specs set.</li>
      <li><code>fix-tests-and-code</code> — iterates run-tests + build-code to repair failing suites and code.</li>
      <li><code>run-tests</code> — executes <code>runAlltests.js</code> (optionally scoped to a suite) and returns results.</li>
      <li><code>spec-review</code> — LLM review of specs with structured findings and recommendations.</li>
      <li><code>refactor-design</code> — captures refactor intents into DS updates and triggers build-code.</li>
      <li><code>generic-skill</code> — fallback tool runner (list/read/rewrite/replace/create/delete files) when no specific skill fits.</li>
      <li><code>spec-mentor</code> — educational guidance on URS/FS/NFS/DS/tests with suggested next steps.</li>
      <li><code>mock-build</code> — non-mutating spec summary and HTML preview for quick overviews.</li>
      <li><code>spec-help</code> — concise refresher on the GAMP spec stack and best practices.</li>
      <li><code>specPlanner</code> (utility) — shared planner/executor for spec skills (parses plans, applies GampRSP actions).</li>
    </ul>
    <p><small><sup>1</sup>oskill: orchestrator-type skill that plans and coordinates other skills; it does not answer the prompt directly.</small></p>

    <h3>Execution in practice (iterative spec cycle)</h3>
    <p>
      You can compose the existing skills to build and refine specs end-to-end, including backtracking:
    </p>
    <ol>
      <li><strong>Draft specs</strong>: run <code>update-specs</code> with your change request to create/adjust URS/FS/NFS/DS and file impacts.</li>
      <li><strong>Preview</strong>: use <code>mock-build</code> to generate a non-mutating HTML summary and inspect the changes.</li>
      <li><strong>Regenerate code/tests</strong>: if the DS looks good, run <code>build-code</code> to materialize files and scaffold FS/NFS test suites.</li>
      <li><strong>Backtrack/refine</strong>: if the preview or generated files aren’t what you want, run <code>sync-specs</code> to re-sync specs from code or rerun <code>update-specs</code> with revised instructions (e.g., new constraints or different file impacts).</li>
      <li><strong>Repair loops</strong>: if tests/code drift, use <code>fix-tests-and-code</code> to iterate run-tests + build-code until stabilized.</li>
      <li><strong>Review and mentor</strong>: call <code>spec-review</code> for findings and <code>spec-mentor</code> for educational guidance before finalizing.</li>
      <li><strong>Publish</strong>: regenerate docs with <code>generate-docs</code> to update HTML outputs, or <code>run-tests</code> to validate suites.</li>
    </ol>

    <div class="footer-nav">
      <span>AchillesCLI · Architecture</span>
      <span><a href="../specs/matrix.html">Specification Matrix</a></span>
    </div>
  </div>
</body>
</html>
