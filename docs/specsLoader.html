<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Specification Loader - AchillesCLI</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .spec-container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        .spec-nav { background: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 20px; }
        .spec-content { background: white; padding: 20px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .error { color: #d32f2f; background: #ffebee; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .back-link { margin-bottom: 20px; }
        .spec-id { background: #e3f2fd; padding: 2px 8px; border-radius: 3px; font-family: monospace; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="page">
        <div class="nav-header">
            <h1>Specification Loader</h1>
            <small>
                <a href="index.html">Home</a> ·
                <a href="specs/matrix.html">Specs</a> ·
                <span id="current-spec">Loading...</span>
            </small>
        </div>

        <div class="spec-container">
            <div class="back-link">
                <a href="specs/matrix.html">← Back to Specification Matrix</a>
            </div>

            <div id="content">
                <div class="loading">Loading specification...</div>
            </div>
        </div>
    </div>

    <script>
        class SpecsLoader {
            constructor() {
                this.content = document.getElementById('content');
                this.currentSpecSpan = document.getElementById('current-spec');
                this.specPath = this.getSpecPath();
                this.load();
            }

            getSpecPath() {
                const params = new URLSearchParams(window.location.search);
                return params.get('spec');
            }

            async load() {
                if (!this.specPath) {
                    window.location.href = 'specs/matrix.html';
                    return;
                }

                try {
                    this.currentSpecSpan.textContent = `Loading: ${this.specPath}`;
                    const response = await fetch(`specs/${this.specPath}`);
                    if (!response.ok) {
                        throw new Error(`Specification not found: ${this.specPath}`);
                    }
                    const markdown = await response.text();
                    const html = this.markdownToHtml(markdown);
                    this.content.innerHTML = html;
                    this.currentSpecSpan.textContent = this.specPath;
                    this.scrollToHash();
                    const titleMatch = markdown.match(/^#\s+(.+)$/m);
                    if (titleMatch) {
                        document.title = `${titleMatch[1]} - AchillesCLI`;
                    }
                } catch (error) {
                    this.showError(error.message);
                }
            }

            scrollToHash() {
                const hash = decodeURIComponent(window.location.hash.slice(1));
                if (!hash) return;
                const target = document.getElementById(hash);
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }

            showError(message) {
                this.content.innerHTML = `
                    <div class="error">
                        <h3>Error Loading Specification</h3>
                        <p>${message}</p>
                        <p><a href="specs/matrix.html">Return to Specification Matrix</a></p>
                    </div>
                `;
                this.currentSpecSpan.textContent = 'Error';
            }

            markdownToHtml(markdown) {
                const escapeHtml = (text) => text
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');

                const applyInline = (text) => escapeHtml(text)
                    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.+?)\*/g, '<em>$1</em>')
                    .replace(/`([^`]+)`/g, (_, code) => `<code>${escapeHtml(code)}</code>`)
                    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>');

                const lines = markdown.split('\n');
                const htmlParts = [];
                let paragraph = [];
                let listItems = [];
                let inCode = false;
                let codeBuffer = [];

                const flushParagraph = () => {
                    if (!paragraph.length) return;
                    const content = paragraph.map(applyInline).join('<br>');
                    htmlParts.push(`<p>${content}</p>`);
                    paragraph = [];
                };

                const flushList = () => {
                    if (!listItems.length) return;
                    htmlParts.push(`<ul>${listItems.map(item => `<li>${item}</li>`).join('')}</ul>`);
                    listItems = [];
                };

                const flushCode = () => {
                    if (!codeBuffer.length) return;
                    htmlParts.push(`<pre><code>${escapeHtml(codeBuffer.join('\n'))}</code></pre>`);
                    codeBuffer = [];
                };

                lines.forEach((rawLine) => {
                    const line = rawLine.trimEnd();
                    const trimmed = line.trim();

                    if (trimmed.startsWith('```')) {
                        if (inCode) {
                            flushCode();
                            inCode = false;
                        } else {
                            flushParagraph();
                            flushList();
                            inCode = true;
                            codeBuffer = [];
                        }
                        return;
                    }

                    if (inCode) {
                        codeBuffer.push(rawLine);
                        return;
                    }

                    if (!trimmed) {
                        flushParagraph();
                        flushList();
                        return;
                    }

                    const headingMatch = trimmed.match(/^(#{1,4})\s+(.+)$/);
                    if (headingMatch) {
                        flushParagraph();
                        flushList();
                        const level = headingMatch[1].length;
                        const text = applyInline(headingMatch[2]);
                        const idMatch = headingMatch[2].match(/\b([A-Z]{2,3}-\d{3})\b/);
                        const idAttr = idMatch ? ` id="${idMatch[1]}"` : '';
                        htmlParts.push(`<h${level}${idAttr}>${text}</h${level}>`);
                        return;
                    }

                    const listMatch = trimmed.match(/^-\s+(.+)/);
                    if (listMatch) {
                        flushParagraph();
                        listItems.push(applyInline(listMatch[1]));
                        return;
                    }

                    // Default: paragraph line
                    flushList();
                    paragraph.push(line);
                });

                flushCode();
                flushList();
                flushParagraph();

                let html = htmlParts.join('');
                html = html.replace(/\*\*ID:\*\* ([A-Z0-9\-\/_.]+)/g,
                    '<strong>ID:</strong> <span class="spec-id">$1</span>');
                return html;
            }
        }

        document.addEventListener('DOMContentLoaded', () => new SpecsLoader());
    </script>
</body>
</html>
